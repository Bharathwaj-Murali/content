id: AWS IAM User Access Investigation
version: -1
name: AWS IAM User Access Investigation
description: "Investigate and respond to Cortex XSIAM alerts where an AWS IAM user`s access key is used suspiciously to access the cloud environment. \nThe following alerts are supported for AWS environments.\n- Penetration testing tool attempt\n- Penetration testing tool activity\n- Suspicious API call from a Tor exit node\n This is a beta playbook, which lets you implement and test pre-release software. Although AWS is supported, we are working towards multi-cloud support. As the playbook is beta, it might contain bugs. Updates to the playbook during the beta phase might include non-backward compatible features. We encourage feedback on the quality and usability of the content to help us identify and fix issues, so we can continually improve the content.\n"
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 8a8ad825-1cee-4b65-8bd3-b50b419cdfcc
    type: start
    task:
      id: 8a8ad825-1cee-4b65-8bd3-b50b419cdfcc
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": -70
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "8":
    id: "8"
    taskid: d5e35433-18c5-4ac5-8725-a4e034eed667
    type: title
    task:
      id: d5e35433-18c5-4ac5-8725-a4e034eed667
      version: -1
      name: 'Remediation '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "54"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "19":
    id: "19"
    taskid: 20b6b05d-6b6a-44d7-843b-498f7a21d442
    type: title
    task:
      id: 20b6b05d-6b6a-44d7-843b-498f7a21d442
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 510,
          "y": 1750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "21":
    id: "21"
    taskid: 9988a925-09f0-4b12-8c73-585ec6a10430
    type: condition
    task:
      id: 9988a925-09f0-4b12-8c73-585ec6a10430
      version: -1
      name: Manual decision making - true/false-positive alert
      description: Based on the collected data investigation and the verdict established by the "Enrichment for Verdict" playbook, is this a true positive event?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      False Positive:
      - "64"
      True positive:
      - "8"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 220,
          "y": 920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "22":
    id: "22"
    taskid: 0a778e48-7ba1-4367-80ab-db14154497ed
    type: title
    task:
      id: 0a778e48-7ba1-4367-80ab-db14154497ed
      version: -1
      name: False Positive - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -90,
          "y": 1610
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "48":
    id: "48"
    taskid: 584f23b5-3af1-43e9-8da9-7d0443e1afdd
    type: title
    task:
      id: 584f23b5-3af1-43e9-8da9-7d0443e1afdd
      version: -1
      name: Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "61"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 80
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "50":
    id: "50"
    taskid: 3f0b5ced-1ef7-47a2-8a41-25675867ac99
    type: title
    task:
      id: 3f0b5ced-1ef7-47a2-8a41-25675867ac99
      version: -1
      name: Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "66"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "54":
    id: "54"
    taskid: 56c34066-e6c8-452a-89c6-0a982f639313
    type: playbook
    task:
      id: 56c34066-e6c8-452a-89c6-0a982f639313
      version: -1
      name: AWS IAM User Access Investigation - Remediation
      description: "Investigate and respond to Cortex XSIAM alerts where an AWS IAM user`s access key is used suspiciously to access the cloud environment. \nThe following alerts are supported for AWS environments.\n- Penetration testing tool attempt\n- Penetration testing tool activity\n- Suspicious API call from a Tor exit node\n This is a beta playbook, which lets you implement and test pre-release software. Although AWS is supported, we are working towards multi-cloud support. As the playbook is beta, it might contain bugs. Updates to the playbook during the beta phase might include non-backward compatible features. We encourage feedback on the quality and usability of the content to help us identify and fix issues, sp we can continually improve content.\n"
      playbookName: AWS IAM User Access Investigation - Remediation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      AutoBlockIP:
        complex:
          root: inputs.AutoBlockIP
      AutoDeleteProfile:
        complex:
          root: inputs.AutoDeleteProfile
      DAG:
        complex:
          root: inputs.DAG
      IP:
        complex:
          root: alert
          accessor: hostip
      IndicatorTag:
        complex:
          root: inputs.IndicatorTag
      accessKeyId:
        complex:
          root: Core.OriginalAlert.event.identity_orig
          accessor: accessKeyId
      userName:
        complex:
          root: alert
          accessor: username
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 550,
          "y": 1240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "57":
    id: "57"
    taskid: 23b257f0-23b3-46c2-8e9d-3b347a6bc9b1
    type: condition
    task:
      id: 23b257f0-23b3-46c2-8e9d-3b347a6bc9b1
      version: -1
      name: Close the alert and finish the investigation?
      description: "Close the alert and finish the investigation?"
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "65"
      "yes":
      - "58"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 1410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "58":
    id: "58"
    taskid: b5e4cf03-33df-424d-8bbd-f83d9ede11fe
    type: regular
    task:
      id: b5e4cf03-33df-424d-8bbd-f83d9ede11fe
      version: -1
      name: Close alert after remediation
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 780,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "60":
    id: "60"
    taskid: 3efcf72d-30f2-4ae1-811b-dcad46f801b2
    type: playbook
    task:
      id: 3efcf72d-30f2-4ae1-811b-dcad46f801b2
      version: -1
      name: Enrichment for Verdict
      playbookName: Enrichment for Verdict
      type: playbook
      iscommand: false
      brand: ""
      description: 'This playbook checks prior alert closing reasons and performs enrichment and prevalence checks on different IOC types. It then returns the information needed to establish the alert''s verdict.'
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      CloseReason:
        simple: Resolved - False Positive,Resolved - Duplicate Incident,Resolved - Known Issue
      Domain:
        complex:
          root: alert
          accessor: domainname
      FileSHA256:
        complex:
          root: alert
          accessor: initiatorsha256
      IP:
        complex:
          root: alert
          accessor: hostip
      URL:
        complex:
          root: alert
          accessor: url
      User:
        complex:
          root: alert
          accessor: username
      awsUser:
        complex:
          root: alert
          accessor: username
      query:
        simple: (hostip:${alert.hostip}) and alertsource:${alert.sourceBrand} and alertname:${alert.name}
      threshold:
        simple: "5"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 550,
          "y": 420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "61":
    id: "61"
    taskid: 1043efe9-eaa1-4311-8f72-8597ff5de06d
    type: regular
    task:
      id: 1043efe9-eaa1-4311-8f72-8597ff5de06d
      version: -1
      name: Get cloud original alert
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "60"
    scriptarguments:
      alert_ids:
        complex:
          root: alert
          accessor: id
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "64":
    id: "64"
    taskid: 0f46be32-5995-4574-8992-d941ad137547
    type: playbook
    task:
      id: 0f46be32-5995-4574-8992-d941ad137547
      version: -1
      name: Handle False Positive Alerts
      description: |
        This playbook handles false positive alerts.
      playbookName: Handle False Positive Alerts
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      ShouldCloseAutomatically:
        complex:
          root: inputs.ShouldCloseAutomatically
      alertName:
        complex:
          root: alert
          accessor: name
      sourceIP:
        complex:
          root: alert
          accessor: hostip
      username:
        complex:
          root: alert
          accessor: username
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -90,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "65":
    id: "65"
    taskid: 537b3b48-845b-475d-8d62-a0cfaf6578bd
    type: regular
    task:
      id: 537b3b48-845b-475d-8d62-a0cfaf6578bd
      version: -1
      name: Continue the investigation
      description: Continue the investigation.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 320,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "66":
    id: "66"
    taskid: 401759a1-699c-4dda-8780-0e1449454b10
    type: condition
    task:
      id: 401759a1-699c-4dda-8780-0e1449454b10
      version: -1
      name: Is it a suspicious or Tor IP?
      description: Is it a suspicious or Tor IP?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "21"
      "yes":
      - "8"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: DBotScore
            iscontext: true
          right:
            value:
              simple: "3"
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              complex:
                root: alert
                accessor: alertname
            iscontext: true
          right:
            value:
              simple: Suspicious API call from a Tor exit node
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              complex:
                root: IPVerdict
            iscontext: true
          right:
            value:
              simple: Suspicious
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              complex:
                root: Core.AnalyticsPrevalence.Ip
                accessor: value
            iscontext: true
          right:
            value:
              simple: "false"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 550,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
view: |-
  {
    "linkLabelsPosition": {
      "21_64_False Positive": 0.54,
      "21_8_True positive": 0.48,
      "57_58_yes": 0.82,
      "66_8_yes": 0.37
    },
    "paper": {
      "dimensions": {
        "height": 1885,
        "width": 1250,
        "x": -90,
        "y": -70
      }
    }
  }
inputs:
- key: AutoDeleteProfile
  value:
    simple: "False"
  required: false
  description: Whether to automatically delete the user login profile if it exists (True/False).
  playbookInputQuery:
- key: AutoBlockIP
  value:
    simple: "False"
  required: false
  description: 'Whether to initiate block IP playbook automatically (True/False). '
  playbookInputQuery:
- key: IndicatorTag
  value: {}
  required: false
  description: |-
    The tag name for bad reputation IP addresses investigated in the incident.
    Use this when the EDL service is configured to add indicators to block in PANW PAN-OS.
    If the indicator verdict (Malicious/Bad) is used to add indicators to Cortex XSIAM EDL you don't need to use the tag. Indicators are set as malicious, automatically in the incident.
  playbookInputQuery:
- key: DAG
  value: {}
  required: false
  description: |-
    This input determines whether Palo Alto Networks Panorama or Firewall Dynamic Address Groups are used.
    Specify the Dynamic Address Group tag name for IP handling.
  playbookInputQuery:
- key: ShouldCloseAutomatically
  value: {}
  required: false
  description: Whether to close alerts automatically as a false positive (True/False).
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.6.0
